{"title":"buu-Warmup","slug":"buu-Warmup","date":"2021-01-31T09:28:53.000Z","updated":"2021-01-31T10:19:47.246Z","comments":true,"path":"api/articles/buu-Warmup.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<h2 id=\"根据题目得到代码如下，开始代码审计\"><a href=\"#根据题目得到代码如下，开始代码审计\" class=\"headerlink\" title=\"根据题目得到代码如下，开始代码审计\"></a>根据题目得到代码如下，开始代码审计</h2><pre><code>&lt;?php\n    highlight_file(__FILE__);\nclass emmm\n&#123;\n    public static function checkFile(&amp;$page)\n    &#123;\n        $whitelist = [&quot;source&quot;=&gt;&quot;source.php&quot;,&quot;hint&quot;=&gt;&quot;hint.php&quot;];\n        //得到另外一个文件hint.php，包含得到flag的文件名\n\n        //isset()判断变量是否声明，is_string()判断变量是否是字符串\n        if (! isset($page) || !is_string($page)) &#123;\n            echo &quot;you can&#39;t see it&quot;;\n            return false;\n        &#125;\n\n        //检测传进来的值是否匹配白名单列表$whitelist 如果有则执行真\n        if (in_array($page, $whitelist)) &#123;            \n            return true;\n        &#125;\n\n        //过滤问号的函数(如果$page的值有？则从?之前提取字符串)\n        $_page = mb_substr(\n            $page,\n            0,\n            mb_strpos($page . &#39;?&#39;, &#39;?&#39;)\n        );\n\n        //第二次检测传进来的值是否匹配白名单列表$whitelist\n        if (in_array($_page, $whitelist)) &#123;\n            return true;\n        &#125;\n\n        //对$page进行url解码\n        $_page = urldecode($page);\n\n         //第二次过滤问号的函数(如果$page的值有？则从?之前提取字符串)\n        $_page = mb_substr(\n            $_page,\n            0,\n            mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)\n        );\n\n        //第三次检测传进来的值是否匹配白名单列表$whitelist\n        if (in_array($_page, $whitelist)) &#123;\n            return true;\n        &#125;\n\n        //若以上都没通过，则返回false\n        echo &quot;you can&#39;t see it&quot;;\n        return false;\n    &#125;\n&#125;\n\n//---------------------------------------------------------------\n//这里就到了文件包含，需要传入的参数file不为空且是字符串，经过class emmm的检测，即emmm返回真，则包含file    \nif (! empty($_REQUEST[&#39;file&#39;])\n    &amp;&amp; is_string($_REQUEST[&#39;file&#39;])\n    &amp;&amp; emmm::checkFile($_REQUEST[&#39;file&#39;])\n) &#123;\n    include $_REQUEST[&#39;file&#39;];\n    exit;\n&#125; else &#123;\n    echo &quot;&lt;br&gt;&lt;img src=\\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\\&quot; /&gt;&quot;;\n&#125;  \n?&gt;</code></pre>\n<hr>\n<p>观察源码发现hint.php，打开发现<br>flag not here, and flag in ffffllllaaaagggg<br>如果满足相应的条件，include引入文件。只需使emmm::checkFile($_REQUEST[‘file’]返回值为true，利用../跳转目录读取flag即可。<br>payload为：file=source.php?/../ffffllllaaaagggg，经过mb_strpos为source.php?/../ffffllllaaaagggg?,  但是mb_strpos这个函数只返回首次出现的位置，所以还是会返回第一个？的位置，而mb_substr截取函数，从0开始截取一直到第一个？的位置，截取内容为source.php，恰好能与白名单中的进行匹配，可以return true;，所以通过第一次截取进行绕过<br>ffffllllaaaagggg文件和index.php不在同一个目录下，所以读取的是上级目录。构造payload <a href=\"http://web5.buuctf.cn/?file=source.php?../../../../../ffffllllaaaagggg%EF%BC%8C%E6%89%BE%E5%88%B0flag%EF%BC%88%E5%88%A9%E7%94%A8/%E4%BD%BFsource.php?%E6%88%90%E4%B8%BA%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E6%9C%80%E5%90%8Einclude%E5%88%A9%E7%94%A8../%E8%B7%B3%E8%BD%AC%E7%9B%AE%E5%BD%95%E8%AF%BB%E5%8F%96flag%E5%8D%B3%E5%8F%AF%EF%BC%89\">http://web5.buuctf.cn/?file=source.php?../../../../../ffffllllaaaagggg，找到flag（利用/使source.php?成为一个不存在的目录，最后include利用../跳转目录读取flag即可）</a>  </p>\n<ul>\n<li>注意：../ 有多少个不一定，因为不知道flag在底几层目录里，需要从没有开始一次加一个去尝试。</li>\n</ul>\n","categories":[],"tags":[]}